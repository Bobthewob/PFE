@section Styles {
    <link href="@Url.Content("~/Content/Composant.css")" rel="stylesheet" type="text/css" />
}

<h2>Liste des applications et services</h2>

<div class="divListe">
    <div class="search-group">
        <div class="search-input input-group">
            <span class="input-group-addon transparent"><span class="glyphicon glyphicon-search"></span></span>
            <input type="text" id="txtFiltre" class="form-control left-border-none" placeholder="Rechercher">
        </div>
        <button type="button" id="btnExportCourt" class="btn btn-default">Export court</button>
        <button type="button" id="btnExportLong" class="btn btn-default">Export long</button>
    </div>

    <div id="listeComposant"></div>
</div>

<a id="scroll-up" href="#" class="btn btn-primary btn-lg scroll-up" role="button"><span class="glyphicon glyphicon-chevron-up"></span></a>


<script>
    var offset = 0; //current pagination offset
    var take = 5; //how much we want to load for each ajax call
    var currentAjaxFetch; //the current ajax query, we don't want it to complete if we lauch a new search with a new filter for example

    $(document).ready(function () {
        //https://bootsnipp.com/snippets/featured/link-to-top-page
        $(window).scroll(function () {
            if ($(this).scrollTop() > 50) {
                $('#scroll-up').fadeIn();
            } else {
                $('#scroll-up').fadeOut();
            }
        });

        $('#scroll-up').click(function () {
            $('#scroll-up').tooltip('hide');
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });

        $("#txtFiltre").on('input', function (e) {
            if (currentFetch)
                currentFetch.abort("new filter called");

            filtrerListe($(this).val(), true);
        });

        filtrerListe("", true);
    });

    function filtrerListe(filtre, resetPagination) {
        if (resetPagination) {
            offset = 0;
            $("#listeComposant").html(""); //remove all elements

            currentFetch = CallController(
                "@Url.Action("GetComposants", "Composant")",
                { filtre: filtre, take: take }
            ).done(function (result) {
                $("#listeComposant").html(result);
                offset = offset + take;
                filtrerListe(filtre);
            });
        }
        else {
            currentFetch = CallController(
                "@Url.Action("GetComposants", "Composant")",
                { filtre: filtre, take: take, offset: offset }
            ).done(function (result) {
                if (result.status !== "All_Loaded") { //as long as we haven't loaded all elements we keep going
                    $("#listeComposant").append(result); //add the new element at the end of the list
                    offset = offset + take;
                    filtrerListe(filtre); 
                }
               
            });
        }
    }
</script>